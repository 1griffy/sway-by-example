// metadata
export const version = "0.59.0"
export const title = "Uniswap V2"
export const description = "Uniswap V2"

export const tempFileName = "uniswapv2.sw"
export const tempPlaygroundLink =
  "https://www.sway-playground.org/?toolchain=beta-5&transpile=false&gist=d5f9c08ea503f022c58d77feb4149f35"

export const keywords = ["defi", "uniswap", "v2", "swap", "amm"]

export const codes = [
  {
    fileName: "UniswapV2.rs",
    code: "Ly8gQ29uc3RhbnQgUHJvZHVjdCBBTU0gLSBVbmlzd2FwIFYyLgpjb250cmFjdDsKCnVzZSBzcmMyMDo6U1JDMjA7CnVzZSBzdGQ6OnsKICAgIHUxMjg6OlUxMjgsCiAgICBoYXNoOjpzaGEyNTYsCiAgICBhc3NldDo6dHJhbnNmZXIsCiAgICBoYXNoOjpIYXNoLAogICAgYXNzZXRfaWQ6OkFzc2V0SWQsCiAgICBhc3NldDo6ewogICAgICAgIGJ1cm4sCiAgICAgICAgbWludF90bywKICAgIH0sCiAgICBjb250cmFjdF9pZDo6Q29udHJhY3RJZCwKICAgIGNhbGxfZnJhbWVzOjp7CiAgICAgICAgbXNnX2Fzc2V0X2lkLAogICAgfSwKICAgIGNvbnRleHQ6Om1zZ19hbW91bnQsCiAgICBzdHJpbmc6OlN0cmluZywKfTsKCmFiaSBDb25zdGFudFN1bUFNTSB7CiAgICAjW3N0b3JhZ2UocmVhZCwgd3JpdGUpLCBwYXlhYmxlXQogICAgZm4gZGVwb3NpdCgpOwoKICAgICNbc3RvcmFnZShyZWFkLCB3cml0ZSldCiAgICBmbiB3aXRoZHJhdyhyZWNpcGllbnQ6IElkZW50aXR5LCBhc3NldDogQXNzZXRJZCk7CgogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gZ2V0X3Bvb2woYXNzZXRfYTogQXNzZXRJZCkgLT4gT3B0aW9uPFBvb2w+OwoKICAgICNbc3RvcmFnZShyZWFkLCB3cml0ZSksIHBheWFibGVdCiAgICBmbiBhZGRfbGlxdWlkaXR5KGFzc2V0X2E6IEFzc2V0SWQsIGFzc2V0X2I6IEFzc2V0SWQpIC0+IHU2NDsKCiAgICAjW3N0b3JhZ2UocmVhZCwgd3JpdGUpLCBwYXlhYmxlXQogICAgZm4gcmVtb3ZlX2xpcXVpZGl0eShhc3NldF9hOiBBc3NldElkLCBhc3NldF9iOiBBc3NldElkKSAtPiAodTY0LCB1NjQpOwoKICAgICNbc3RvcmFnZShyZWFkLCB3cml0ZSksIHBheWFibGVdCiAgICBmbiBzd2FwKGFzc2V0X2E6IEFzc2V0SWQsIGFzc2V0X2I6IEFzc2V0SWQpIC0+IHU2NDsKfQoKc3RydWN0IFBvb2wgewogICAgcmVzZXJ2ZV9hOiB1NjQsCiAgICByZXNlcnZlX2I6IHU2NCwKICAgIHRvdGFsX3N1cHBseTogdTY0Cn0KCnN0b3JhZ2UgewogICAgdG90YWxfcG9vbHM6IHU2NCA9IDAsCiAgICBwb29sczogU3RvcmFnZU1hcDxBc3NldElkLCBQb29sPiA9IFN0b3JhZ2VNYXAge30sCiAgICBkZXBvc2l0czogU3RvcmFnZU1hcDwoSWRlbnRpdHksIEFzc2V0SWQpLCB1NjQ+ID0gU3RvcmFnZU1hcCB7fSwKfQoKaW1wbCBTUkMyMCBmb3IgQ29udHJhY3QgewogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gdG90YWxfYXNzZXRzKCkgLT4gdTY0IHsKICAgICAgICBzdG9yYWdlLnRvdGFsX3Bvb2xzLnRyeV9yZWFkKCkudW53cmFwX29yKDApCiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gdG90YWxfc3VwcGx5KGFzc2V0OiBBc3NldElkKSAtPiBPcHRpb248dTY0PiB7CiAgICAgICAgbGV0IHBvb2wgPSBzdG9yYWdlLnBvb2xzLmdldChhc3NldCkudHJ5X3JlYWQoKTsKICAgICAgICAKICAgICAgICBtYXRjaCBwb29sIHsKICAgICAgICAgICAgU29tZSh4KSA9PiBTb21lKHgudG90YWxfc3VwcGx5KSwKICAgICAgICAgICAgTm9uZSA9PiBOb25lLAogICAgICAgIH0KICAgIH0KCiAgICAjW3N0b3JhZ2UocmVhZCldCiAgICBmbiBuYW1lKGFzc2V0OiBBc3NldElkKSAtPiBPcHRpb248U3RyaW5nPiB7CiAgICAgICAgU29tZShTdHJpbmc6OmZyb21fYXNjaWlfc3RyKGZyb21fc3RyX2FycmF5KF9fdG9fc3RyX2FycmF5KCJDb25zdGFudFN1bUFNTSIpKSkpCiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gc3ltYm9sKGFzc2V0OiBBc3NldElkKSAtPiBPcHRpb248U3RyaW5nPiB7CiAgICAgICAgU29tZShTdHJpbmc6OmZyb21fYXNjaWlfc3RyKGZyb21fc3RyX2FycmF5KF9fdG9fc3RyX2FycmF5KCJBTU1MUCIpKSkpCiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gZGVjaW1hbHMoYXNzZXQ6IEFzc2V0SWQpIC0+IE9wdGlvbjx1OD4gewogICAgICAgIFNvbWUoOSkKICAgIH0KfQoKI1tzdG9yYWdlKHJlYWQsIHdyaXRlKSwgcGF5YWJsZV0KZm4gZGVwb3NpdF9vcl9jYWxsKGFzc2V0OiBBc3NldElkKSAtPiB1NjQgewogICAgbWF0Y2ggbXNnX2Ftb3VudCgpID4gMCB7CiAgICAgICAgdHJ1ZSA9PiB7CiAgICAgICAgICAgIHJlcXVpcmUobXNnX2Fzc2V0X2lkKCkgPT0gYXNzZXQsICJpbnZhbGlkIGNhbGxlZCBhc3NldCBpZCIpOwoKICAgICAgICAgICAgbXNnX2Ftb3VudCgpCiAgICAgICAgfSwKICAgICAgICBmYWxzZSA9PiB7CiAgICAgICAgICAgIGxldCBvd25lciA9IG1zZ19zZW5kZXIoKS51bndyYXAoKTsKICAgICAgICAgICAgbGV0IGFtb3VudCA9IHN0b3JhZ2UuZGVwb3NpdHMuZ2V0KChvd25lciwgYXNzZXQpKS50cnlfcmVhZCgpLnVud3JhcF9vcigwKTsKCiAgICAgICAgICAgIGFtb3VudAogICAgICAgIH0KICAgIH0KfQoKZm4gYmlnKHZhbHVlOiB1NjQpIC0+IFUxMjggewogICAgVTEyODo6ZnJvbSgoMCwgdmFsdWUpKQp9CgpmbiBtaW4odmFsdWVfYTogVTEyOCwgdmFsdWVfYjogVTEyOCkgLT4gVTEyOCB7CiAgICBpZiB2YWx1ZV9hID4gdmFsdWVfYiB7CiAgICAgICAgdmFsdWVfYgogICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZV9hCiAgICB9Cn0KCmltcGwgQ29uc3RhbnRTdW1BTU0gZm9yIENvbnRyYWN0IHsKICAgICNbc3RvcmFnZShyZWFkLCB3cml0ZSksIHBheWFibGVdCiAgICBmbiBkZXBvc2l0KCkgewogICAgICAgIHJlcXVpcmUobXNnX2Ftb3VudCgpID49IDAsICJJbmNvcnJlY3QgYW1vdW50IHByb3ZpZGVkIik7CgogICAgICAgIGxldCBvd25lciA9IG1zZ19zZW5kZXIoKS51bndyYXAoKTsKICAgICAgICBsZXQgYXNzZXRfaWQgPSBtc2dfYXNzZXRfaWQoKTsKICAgICAgICBsZXQgYW1vdW50ID0gc3RvcmFnZS5kZXBvc2l0cy5nZXQoKG93bmVyLCBhc3NldF9pZCkpLnRyeV9yZWFkKCkudW53cmFwX29yKDApOwoKICAgICAgICBzdG9yYWdlLmRlcG9zaXRzLmluc2VydCgob3duZXIsIGFzc2V0X2lkKSwgYW1vdW50ICsgbXNnX2Ftb3VudCgpKTsKICAgIH0KCiAgICAjW3N0b3JhZ2UocmVhZCwgd3JpdGUpXQogICAgZm4gd2l0aGRyYXcocmVjaXBpZW50OiBJZGVudGl0eSwgYXNzZXRfaWQ6IEFzc2V0SWQpIHsKICAgICAgICBsZXQgb3duZXIgPSBtc2dfc2VuZGVyKCkudW53cmFwKCk7CiAgICAgICAgbGV0IGJhbGFuY2UgPSBzdG9yYWdlLmRlcG9zaXRzLmdldCgob3duZXIsIGFzc2V0X2lkKSkudHJ5X3JlYWQoKS51bndyYXBfb3IoMCk7CgogICAgICAgIHRyYW5zZmVyKHJlY2lwaWVudCwgYXNzZXRfaWQsIGJhbGFuY2UpOwoKICAgICAgICBzdG9yYWdlLmRlcG9zaXRzLnJlbW92ZSgob3duZXIsIGFzc2V0X2lkKSk7CiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQsIHdyaXRlKSwgcGF5YWJsZV0KICAgIGZuIHN3YXAoYXNzZXRfYTogQXNzZXRJZCwgYXNzZXRfYjogQXNzZXRJZCkgLT4gdTY0IHsKICAgICAgICByZXF1aXJlKG1zZ19hbW91bnQoKSA+PSAwLCAiSW5jb3JyZWN0IGFtb3VudCBwcm92aWRlZCIpOwoKICAgICAgICBsZXQgb3duZXIgPSBtc2dfc2VuZGVyKCkudW53cmFwKCk7CiAgICAgICAgbGV0IGFtb3VudCA9IGRlcG9zaXRfb3JfY2FsbChhc3NldF9hKTsKCiAgICAgICAgcmVxdWlyZShhc3NldF9hID09IGFzc2V0X2IsICJpbnZhbGlkIHRva2VuIik7CgogICAgICAgIGxldCBzdWJfaWQgPSBzaGEyNTYoKGFzc2V0X2EsIGFzc2V0X2IpKTsKICAgICAgICBsZXQgcG9vbF9pZCA9IEFzc2V0SWQ6Om5ldyhDb250cmFjdElkOjp0aGlzKCksIHN1Yl9pZCk7CiAgICAgICAgbGV0IHBvb2wgPSBzdG9yYWdlLnBvb2xzLmdldChwb29sX2lkKS50cnlfcmVhZCgpLnVud3JhcCgpOwogICAgICAgIAogICAgICAgIGxldCBhbW91bnRfaW4gPSAoKGJpZyhhbW91bnQpICogYmlnKDk5NykpIC8gYmlnKDEwMDApKS5hc191NjQoKS51bndyYXAoKTsKICAgICAgICBsZXQgYW1vdW50X291dCA9ICgoYmlnKHBvb2wucmVzZXJ2ZV9iKSAqIGJpZyhhbW91bnRfaW4pKQogICAgICAgICAgICAvIChiaWcocG9vbC5yZXNlcnZlX2EpICsgYmlnKGFtb3VudF9pbikpKS5hc191NjQoKS51bndyYXAoKTsKCiAgICAgICAgc3RvcmFnZS5wb29scy5pbnNlcnQocG9vbF9pZCwgUG9vbCB7CiAgICAgICAgICAgIHJlc2VydmVfYTogcG9vbC5yZXNlcnZlX2EgKyBhbW91bnRfaW4sCiAgICAgICAgICAgIHJlc2VydmVfYjogcG9vbC5yZXNlcnZlX2IgLSBhbW91bnRfb3V0LAogICAgICAgICAgICB0b3RhbF9zdXBwbHk6IHBvb2wudG90YWxfc3VwcGx5CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgdHJhbnNmZXIob3duZXIsIGFzc2V0X2IsIGFtb3VudF9vdXQpOwogICAgICAgIAogICAgICAgIGFtb3VudF9vdXQKICAgIH0KCiAgICAjW3N0b3JhZ2UocmVhZCwgd3JpdGUpLCBwYXlhYmxlXQogICAgZm4gYWRkX2xpcXVpZGl0eShhc3NldF9hOiBBc3NldElkLCBhc3NldF9iOiBBc3NldElkKSAtPiB1NjQgewogICAgICAgIGxldCBvd25lciA9IG1zZ19zZW5kZXIoKS51bndyYXAoKTsKICAgICAgICBsZXQgYW1vdW50X2EgPSBkZXBvc2l0X29yX2NhbGwoYXNzZXRfYSk7CgogICAgICAgIGxldCBhbW91bnRfYiA9IHN0b3JhZ2UuZGVwb3NpdHMuZ2V0KChvd25lciwgYXNzZXRfYikpLnRyeV9yZWFkKCkudW53cmFwX29yKDApOwogICAgICAgIGxldCBzdWJfaWQgPSBzaGEyNTYoKGFzc2V0X2EsIGFzc2V0X2IpKTsKICAgICAgICBsZXQgcG9vbF9pZCA9IEFzc2V0SWQ6Om5ldyhDb250cmFjdElkOjp0aGlzKCksIHN1Yl9pZCk7CiAgICAgICAgbGV0IHBvb2wgPSBzdG9yYWdlLnBvb2xzLmdldChwb29sX2lkKS50cnlfcmVhZCgpLnVud3JhcCgpOwogICAgICAgIGxldCBtdXQgc2hhcmVzID0gMDsKCiAgICAgICAgaWYgKHBvb2wucmVzZXJ2ZV9hID4gMCB8fCBwb29sLnJlc2VydmVfYiA+IDApIHsKICAgICAgICAgICAgcmVxdWlyZSgKICAgICAgICAgICAgICAgIGJpZyhwb29sLnJlc2VydmVfYSkgKiBiaWcoYW1vdW50X2EpID09IGJpZyhwb29sLnJlc2VydmVfYikgKiBiaWcoYW1vdW50X2IpLCAieCAvIHkgIT0gZHggLyBkeSIKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmIChwb29sLnRvdGFsX3N1cHBseSA9PSAwKSB7CiAgICAgICAgICAgIHNoYXJlcyA9IChiaWcoYW1vdW50X2EpICogYmlnKGFtb3VudF9iKSkuc3FydCgpLmFzX3U2NCgpLnVud3JhcCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNoYXJlcyA9IG1pbigKICAgICAgICAgICAgICAgIChiaWcoYW1vdW50X2EpICogYmlnKHBvb2wudG90YWxfc3VwcGx5KSkgLyBiaWcocG9vbC5yZXNlcnZlX2EpLAogICAgICAgICAgICAgICAgKGJpZyhhbW91bnRfYikgKiBiaWcocG9vbC50b3RhbF9zdXBwbHkpKSAvIGJpZyhwb29sLnJlc2VydmVfYikKICAgICAgICAgICAgKS5hc191NjQoKS51bndyYXAoKTsKICAgICAgICB9CgogICAgICAgIHJlcXVpcmUoc2hhcmVzID4gMCwgInNoYXJlcyA9IDAiKTsKCiAgICAgICAgbWludF90byhvd25lciwgc3ViX2lkLCBzaGFyZXMpOwoKICAgICAgICBzdG9yYWdlLnBvb2xzLmluc2VydChwb29sX2lkLCBQb29sIHsKICAgICAgICAgICAgcmVzZXJ2ZV9hOiBhbW91bnRfYSArIHBvb2wucmVzZXJ2ZV9hLAogICAgICAgICAgICByZXNlcnZlX2I6IGFtb3VudF9iIC0gcG9vbC5yZXNlcnZlX2IsCiAgICAgICAgICAgIHRvdGFsX3N1cHBseTogcG9vbC50b3RhbF9zdXBwbHkgKyBzaGFyZXMKICAgICAgICB9KTsKCiAgICAgICAgc2hhcmVzCiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQsIHdyaXRlKSwgcGF5YWJsZV0KICAgIGZuIHJlbW92ZV9saXF1aWRpdHkoYXNzZXRfYTogQXNzZXRJZCwgYXNzZXRfYjogQXNzZXRJZCkgLT4gKHU2NCwgdTY0KSB7CiAgICAgICAgbGV0IG93bmVyID0gbXNnX3NlbmRlcigpLnVud3JhcCgpOwogICAgICAgIGxldCBzdWJfaWQgPSBzaGEyNTYoKGFzc2V0X2EsIGFzc2V0X2IpKTsKICAgICAgICBsZXQgcG9vbF9pZCA9IEFzc2V0SWQ6Om5ldyhDb250cmFjdElkOjp0aGlzKCksIHN1Yl9pZCk7CgogICAgICAgIGxldCBzaGFyZXMgPSBkZXBvc2l0X29yX2NhbGwocG9vbF9pZCk7CiAgICAgICAgbGV0IHBvb2wgPSBzdG9yYWdlLnBvb2xzLmdldChwb29sX2lkKS50cnlfcmVhZCgpLnVud3JhcCgpOwogICAgICAgIGxldCBhbW91bnRfYSA9ICgoYmlnKHNoYXJlcykgKiBiaWcocG9vbC5yZXNlcnZlX2EpKSAvIGJpZyhwb29sLnRvdGFsX3N1cHBseSkpLmFzX3U2NCgpLnVud3JhcCgpOwogICAgICAgIGxldCBhbW91bnRfYiA9ICgoYmlnKHNoYXJlcykgKiBiaWcocG9vbC5yZXNlcnZlX2IpKSAvIGJpZyhwb29sLnRvdGFsX3N1cHBseSkpLmFzX3U2NCgpLnVud3JhcCgpOwoKICAgICAgICByZXF1aXJlKGFtb3VudF9hID4gMCAmJiBhbW91bnRfYiA+IDAsICJhbW91bnQwIG9yIGFtb3VudDEgPSAwIik7CgogICAgICAgIGJ1cm4oc3ViX2lkLCBzaGFyZXMpOwoKICAgICAgICBzdG9yYWdlLnBvb2xzLmluc2VydChwb29sX2lkLCBQb29sIHsKICAgICAgICAgICAgcmVzZXJ2ZV9hOiBwb29sLnJlc2VydmVfYSAtIGFtb3VudF9hLAogICAgICAgICAgICByZXNlcnZlX2I6IHBvb2wucmVzZXJ2ZV9iIC0gYW1vdW50X2IsCiAgICAgICAgICAgIHRvdGFsX3N1cHBseTogcG9vbC50b3RhbF9zdXBwbHkgLSBzaGFyZXMKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGFtb3VudF9hID4gMCkgewogICAgICAgICAgICB0cmFuc2Zlcihvd25lciwgYXNzZXRfYSwgYW1vdW50X2EpOwogICAgICAgIH0KICAgICAgICBpZiAoYW1vdW50X2IgPiAwKSB7CiAgICAgICAgICAgIHRyYW5zZmVyKG93bmVyLCBhc3NldF9iLCBhbW91bnRfYik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIChhbW91bnRfYSwgYW1vdW50X2IpCiAgICB9CgogICAgI1tzdG9yYWdlKHJlYWQpXQogICAgZm4gZ2V0X3Bvb2woYXNzZXRfaWQ6IEFzc2V0SWQpIC0+IE9wdGlvbjxQb29sPiB7CiAgICAgICAgc3RvcmFnZS5wb29scy5nZXQoYXNzZXRfaWQpLnRyeV9yZWFkKCkKICAgIH0KfQo=",
  },
]

const html = `<p>Constant Product AMM (unaudited) in Sway</p>
<pre><code class="language-rust"><span class="hljs-comment">// Constant Product AMM - Uniswap V2.</span>
contract;

<span class="hljs-keyword">use</span> src20::SRC20;
<span class="hljs-keyword">use</span> std::{
    <span class="hljs-type">u128</span>::U128,
    hash::sha256,
    asset::transfer,
    hash::Hash,
    asset_id::AssetId,
    asset::{
        burn,
        mint_to,
    },
    contract_id::ContractId,
    call_frames::{
        msg_asset_id,
    },
    context::msg_amount,
    string::<span class="hljs-type">String</span>,
};

abi ConstantSumAMM {
    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deposit</span>();

    <span class="hljs-meta">#[storage(read, write)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">withdraw</span>(recipient: Identity, asset: AssetId);

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_pool</span>(asset_a: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Pool&gt;;

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_liquidity</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span>;

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">remove_liquidity</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">u64</span>, <span class="hljs-type">u64</span>);

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">swap</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span>;
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pool</span> {
    reserve_a: <span class="hljs-type">u64</span>,
    reserve_b: <span class="hljs-type">u64</span>,
    total_supply: <span class="hljs-type">u64</span>
}

storage {
    total_pools: <span class="hljs-type">u64</span> = <span class="hljs-number">0</span>,
    pools: StorageMap&lt;AssetId, Pool&gt; = StorageMap {},
    deposits: StorageMap&lt;(Identity, AssetId), <span class="hljs-type">u64</span>&gt; = StorageMap {},
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SRC20</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Contract</span> {
    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">total_assets</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> {
        storage.total_pools.<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span>)
    }

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">total_supply</span>(asset: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u64</span>&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool</span> = storage.pools.<span class="hljs-title function_ invoke__">get</span>(asset).<span class="hljs-title function_ invoke__">try_read</span>();
        
        <span class="hljs-keyword">match</span> pool {
            <span class="hljs-title function_ invoke__">Some</span>(x) =&gt; <span class="hljs-title function_ invoke__">Some</span>(x.total_supply),
            <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">None</span>,
        }
    }

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(asset: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; {
        <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_ascii_str</span>(<span class="hljs-title function_ invoke__">from_str_array</span>(__to_str_array(<span class="hljs-string">"ConstantSumAMM"</span>))))
    }

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">symbol</span>(asset: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; {
        <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from_ascii_str</span>(<span class="hljs-title function_ invoke__">from_str_array</span>(__to_str_array(<span class="hljs-string">"AMMLP"</span>))))
    }

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">decimals</span>(asset: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u8</span>&gt; {
        <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">9</span>)
    }
}

<span class="hljs-meta">#[storage(read, write), payable]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">deposit_or_call</span>(asset: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> {
    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">msg_amount</span>() &gt; <span class="hljs-number">0</span> {
        <span class="hljs-literal">true</span> =&gt; {
            <span class="hljs-title function_ invoke__">require</span>(<span class="hljs-title function_ invoke__">msg_asset_id</span>() == asset, <span class="hljs-string">"invalid called asset id"</span>);

            <span class="hljs-title function_ invoke__">msg_amount</span>()
        },
        <span class="hljs-literal">false</span> =&gt; {
            <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-variable">amount</span> = storage.deposits.<span class="hljs-title function_ invoke__">get</span>((owner, asset)).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span>);

            amount
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">big</span>(value: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> U128 {
    U128::<span class="hljs-title function_ invoke__">from</span>((<span class="hljs-number">0</span>, value))
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">min</span>(value_a: U128, value_b: U128) <span class="hljs-punctuation">-&gt;</span> U128 {
    <span class="hljs-keyword">if</span> value_a &gt; value_b {
        value_b
    } <span class="hljs-keyword">else</span> {
        value_a
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ConstantSumAMM</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Contract</span> {
    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deposit</span>() {
        <span class="hljs-title function_ invoke__">require</span>(<span class="hljs-title function_ invoke__">msg_amount</span>() &gt;= <span class="hljs-number">0</span>, <span class="hljs-string">"Incorrect amount provided"</span>);

        <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">asset_id</span> = <span class="hljs-title function_ invoke__">msg_asset_id</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount</span> = storage.deposits.<span class="hljs-title function_ invoke__">get</span>((owner, asset_id)).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span>);

        storage.deposits.<span class="hljs-title function_ invoke__">insert</span>((owner, asset_id), amount + <span class="hljs-title function_ invoke__">msg_amount</span>());
    }

    <span class="hljs-meta">#[storage(read, write)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">withdraw</span>(recipient: Identity, asset_id: AssetId) {
        <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">balance</span> = storage.deposits.<span class="hljs-title function_ invoke__">get</span>((owner, asset_id)).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span>);

        <span class="hljs-title function_ invoke__">transfer</span>(recipient, asset_id, balance);

        storage.deposits.<span class="hljs-title function_ invoke__">remove</span>((owner, asset_id));
    }

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">swap</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> {
        <span class="hljs-title function_ invoke__">require</span>(<span class="hljs-title function_ invoke__">msg_amount</span>() &gt;= <span class="hljs-number">0</span>, <span class="hljs-string">"Incorrect amount provided"</span>);

        <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount</span> = <span class="hljs-title function_ invoke__">deposit_or_call</span>(asset_a);

        <span class="hljs-title function_ invoke__">require</span>(asset_a == asset_b, <span class="hljs-string">"invalid token"</span>);

        <span class="hljs-keyword">let</span> <span class="hljs-variable">sub_id</span> = <span class="hljs-title function_ invoke__">sha256</span>((asset_a, asset_b));
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool_id</span> = AssetId::<span class="hljs-title function_ invoke__">new</span>(ContractId::<span class="hljs-title function_ invoke__">this</span>(), sub_id);
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool</span> = storage.pools.<span class="hljs-title function_ invoke__">get</span>(pool_id).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_in</span> = ((<span class="hljs-title function_ invoke__">big</span>(amount) * <span class="hljs-title function_ invoke__">big</span>(<span class="hljs-number">997</span>)) / <span class="hljs-title function_ invoke__">big</span>(<span class="hljs-number">1000</span>)).<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_out</span> = ((<span class="hljs-title function_ invoke__">big</span>(pool.reserve_b) * <span class="hljs-title function_ invoke__">big</span>(amount_in))
            / (<span class="hljs-title function_ invoke__">big</span>(pool.reserve_a) + <span class="hljs-title function_ invoke__">big</span>(amount_in))).<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();

        storage.pools.<span class="hljs-title function_ invoke__">insert</span>(pool_id, Pool {
            reserve_a: pool.reserve_a + amount_in,
            reserve_b: pool.reserve_b - amount_out,
            total_supply: pool.total_supply
        });
        
        <span class="hljs-title function_ invoke__">transfer</span>(owner, asset_b, amount_out);
        
        amount_out
    }

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_liquidity</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u64</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_a</span> = <span class="hljs-title function_ invoke__">deposit_or_call</span>(asset_a);

        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_b</span> = storage.deposits.<span class="hljs-title function_ invoke__">get</span>((owner, asset_b)).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">let</span> <span class="hljs-variable">sub_id</span> = <span class="hljs-title function_ invoke__">sha256</span>((asset_a, asset_b));
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool_id</span> = AssetId::<span class="hljs-title function_ invoke__">new</span>(ContractId::<span class="hljs-title function_ invoke__">this</span>(), sub_id);
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool</span> = storage.pools.<span class="hljs-title function_ invoke__">get</span>(pool_id).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">shares</span> = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (pool.reserve_a &gt; <span class="hljs-number">0</span> || pool.reserve_b &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_ invoke__">require</span>(
                <span class="hljs-title function_ invoke__">big</span>(pool.reserve_a) * <span class="hljs-title function_ invoke__">big</span>(amount_a) == <span class="hljs-title function_ invoke__">big</span>(pool.reserve_b) * <span class="hljs-title function_ invoke__">big</span>(amount_b), <span class="hljs-string">"x / y != dx / dy"</span>
            );
        }

        <span class="hljs-keyword">if</span> (pool.total_supply == <span class="hljs-number">0</span>) {
            shares = (<span class="hljs-title function_ invoke__">big</span>(amount_a) * <span class="hljs-title function_ invoke__">big</span>(amount_b)).<span class="hljs-title function_ invoke__">sqrt</span>().<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        } <span class="hljs-keyword">else</span> {
            shares = <span class="hljs-title function_ invoke__">min</span>(
                (<span class="hljs-title function_ invoke__">big</span>(amount_a) * <span class="hljs-title function_ invoke__">big</span>(pool.total_supply)) / <span class="hljs-title function_ invoke__">big</span>(pool.reserve_a),
                (<span class="hljs-title function_ invoke__">big</span>(amount_b) * <span class="hljs-title function_ invoke__">big</span>(pool.total_supply)) / <span class="hljs-title function_ invoke__">big</span>(pool.reserve_b)
            ).<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        }

        <span class="hljs-title function_ invoke__">require</span>(shares &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"shares = 0"</span>);

        <span class="hljs-title function_ invoke__">mint_to</span>(owner, sub_id, shares);

        storage.pools.<span class="hljs-title function_ invoke__">insert</span>(pool_id, Pool {
            reserve_a: amount_a + pool.reserve_a,
            reserve_b: amount_b - pool.reserve_b,
            total_supply: pool.total_supply + shares
        });

        shares
    }

    <span class="hljs-meta">#[storage(read, write), payable]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">remove_liquidity</span>(asset_a: AssetId, asset_b: AssetId) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">u64</span>, <span class="hljs-type">u64</span>) {
        <span class="hljs-keyword">let</span> <span class="hljs-variable">owner</span> = <span class="hljs-title function_ invoke__">msg_sender</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">sub_id</span> = <span class="hljs-title function_ invoke__">sha256</span>((asset_a, asset_b));
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool_id</span> = AssetId::<span class="hljs-title function_ invoke__">new</span>(ContractId::<span class="hljs-title function_ invoke__">this</span>(), sub_id);

        <span class="hljs-keyword">let</span> <span class="hljs-variable">shares</span> = <span class="hljs-title function_ invoke__">deposit_or_call</span>(pool_id);
        <span class="hljs-keyword">let</span> <span class="hljs-variable">pool</span> = storage.pools.<span class="hljs-title function_ invoke__">get</span>(pool_id).<span class="hljs-title function_ invoke__">try_read</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_a</span> = ((<span class="hljs-title function_ invoke__">big</span>(shares) * <span class="hljs-title function_ invoke__">big</span>(pool.reserve_a)) / <span class="hljs-title function_ invoke__">big</span>(pool.total_supply)).<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-variable">amount_b</span> = ((<span class="hljs-title function_ invoke__">big</span>(shares) * <span class="hljs-title function_ invoke__">big</span>(pool.reserve_b)) / <span class="hljs-title function_ invoke__">big</span>(pool.total_supply)).<span class="hljs-title function_ invoke__">as_u64</span>().<span class="hljs-title function_ invoke__">unwrap</span>();

        <span class="hljs-title function_ invoke__">require</span>(amount_a &gt; <span class="hljs-number">0</span> &amp;&amp; amount_b &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"amount0 or amount1 = 0"</span>);

        <span class="hljs-title function_ invoke__">burn</span>(sub_id, shares);

        storage.pools.<span class="hljs-title function_ invoke__">insert</span>(pool_id, Pool {
            reserve_a: pool.reserve_a - amount_a,
            reserve_b: pool.reserve_b - amount_b,
            total_supply: pool.total_supply - shares
        });

        <span class="hljs-keyword">if</span> (amount_a &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_ invoke__">transfer</span>(owner, asset_a, amount_a);
        }
        <span class="hljs-keyword">if</span> (amount_b &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_ invoke__">transfer</span>(owner, asset_b, amount_b);
        }
        
        (amount_a, amount_b)
    }

    <span class="hljs-meta">#[storage(read)]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_pool</span>(asset_id: AssetId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Pool&gt; {
        storage.pools.<span class="hljs-title function_ invoke__">get</span>(asset_id).<span class="hljs-title function_ invoke__">try_read</span>()
    }
}
</code></pre>`

export default html
